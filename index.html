<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Controle de Gastos Mensal</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 5px;
        }
        .month-header {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #7f8c8d;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .btn-export {
            background-color: #27ae60;
        }
        .btn-export:hover {
            background-color: #219653;
        }
        .btn-reset {
            background-color: #e74c3c;
        }
        .btn-reset:hover {
            background-color: #c0392b;
        }
        .chart-container {
            margin-top: 30px;
            position: relative;
            height: 300px;
        }
        .total-display {
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Gastos Mensal</h1>
        <div class="month-header" id="currentMonth"></div>
        
        <div class="input-group">
            <input type="number" id="valor" placeholder="Valor" step="0.01" required>
            <select id="categoria">
                <option value="Alimentação">Alimentação</option>
                <option value="Compras Online">Compras Online</option>
                <option value="Transporte">Transporte</option>
                <option value="Lazer">Lazer</option>
                <option value="Outros">Outros</option>
            </select>
            <button onclick="adicionarGasto()">Adicionar</button>
        </div>

        <div class="total-display">
            Total do Mês: <span id="totalMes">R$ 0,00</span>
        </div>

        <div class="input-group">
            <button onclick="exportarEResetar()" class="btn-export">Exportar e Resetar Mês</button>
        </div>

        <div class="chart-container">
            <canvas id="graficoGastos"></canvas>
        </div>
    </div>

    <script>
        // Configuração do Firebase (substitua pelos seus dados)
        const firebaseConfig = {
            apiKey: "AIzaSyB_8NDa0J4LqFiyAlqgkOuJbwVxI9X2X2E",
            authDomain: "controle-gastos-5d942.firebaseapp.com",
            databaseURL: "https://controle-gastos-5d942-default-rtdb.firebaseio.com",
            projectId: "controle-gastos-5d942",
            storageBucket: "controle-gastos-5d942.appspot.com",
            messagingSenderId: "108583061894",
            appId: "1:108583061894:web:4c8f8d1e4e8d5e8a4d3e9a"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let grafico;
        let mesAtual = new Date().toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

        function atualizarMesAtual() {
            document.getElementById('currentMonth').textContent = mesAtual.charAt(0).toUpperCase() + mesAtual.slice(1);
        }

        function adicionarGasto() {
            const valor = parseFloat(document.getElementById('valor').value);
            const categoria = document.getElementById('categoria').value;
            const data = new Date().toLocaleString('pt-BR');
            
            if (isNaN(valor)) {
                alert('Digite um valor válido!');
                return;
            }

            database.ref('gastos').push({
                valor: valor,
                categoria: categoria,
                data: data,
                mes: mesAtual
            });
            
            document.getElementById('valor').value = '';
        }

        function exportarEResetar() {
            if (confirm(`Deseja exportar os gastos de ${mesAtual} e iniciar um novo mês?`)) {
                exportToExcel().then(() => {
                    resetarMes();
                });
            }
        }

        function exportToExcel() {
            return new Promise((resolve) => {
                database.ref('gastos').orderByChild('mes').equalTo(mesAtual).once('value', (snapshot) => {
                    const gastos = [];
                    let total = 0;
                    
                    snapshot.forEach((childSnapshot) => {
                        const gasto = childSnapshot.val();
                        gasto.key = childSnapshot.key;
                        gastos.push(gasto);
                        total += gasto.valor;
                    });

                    // Organiza os dados para o Excel
                    const dadosExcel = gastos.map(gasto => ({
                        'Data': gasto.data,
                        'Categoria': gasto.categoria,
                        'Valor (R$)': gasto.valor
                    }));

                    // Adiciona o total
                    dadosExcel.push({
                        'Data': 'TOTAL',
                        'Categoria': '',
                        'Valor (R$)': total
                    });

                    // Cria a planilha
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(dadosExcel);
                    
                    // Formatação automática
                    ws['!cols'] = [
                        { width: 20 }, // Data
                        { width: 20 }, // Categoria
                        { width: 15 }  // Valor
                    ];

                    // Adiciona cabeçalho em negrito
                    const headerStyle = { font: { bold: true } };
                    for (let key in dadosExcel[0]) {
                        const cell = XLSX.utils.encode_cell({ c: Object.keys(dadosExcel[0]).indexOf(key), r: 0 });
                        if (!ws[cell]) ws[cell] = {};
                        ws[cell].s = headerStyle;
                    }

                    // Formata a linha do total
                    const totalRow = dadosExcel.length;
                    const totalCell = XLSX.utils.encode_cell({ c: 2, r: totalRow - 1 });
                    if (!ws[totalCell]) ws[totalCell] = {};
                    ws[totalCell].s = { font: { bold: true, color: { rgb: "FF0000" } } };

                    XLSX.utils.book_append_sheet(wb, ws, "Gastos");
                    
                    // Gera e faz download do arquivo
                    XLSX.writeFile(wb, `Gastos_${mesAtual.replace(' ', '_')}.xlsx`);
                    resolve();
                });
            });
        }

        function resetarMes() {
            // Atualiza para o novo mês
            const now = new Date();
            mesAtual = now.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            atualizarMesAtual();
            
            // Atualiza o gráfico
            atualizarGrafico({});
            document.getElementById('totalMes').textContent = 'R$ 0,00';
        }

        function atualizarGrafico(dados) {
            const ctx = document.getElementById('graficoGastos').getContext('2d');
            
            if (grafico) {
                grafico.destroy();
            }

            grafico = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{
                        data: Object.values(dados),
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71',
                            '#f1c40f',
                            '#e74c3c',
                            '#9b59b6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Gastos de ${mesAtual} por Categoria`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function calcularTotal(gastos) {
            const total = gastos.reduce((sum, gasto) => sum + gasto.valor, 0);
            document.getElementById('totalMes').textContent = `R$ ${total.toFixed(2)}`;
            return total;
        }

        // Carrega gastos existentes
        database.ref('gastos').orderByChild('mes').equalTo(mesAtual).on('value', (snapshot) => {
            const gastos = [];
            
            snapshot.forEach((childSnapshot) => {
                gastos.push(childSnapshot.val());
            });

            // Calcula e exibe o total
            calcularTotal(gastos);

            // Atualiza gráfico
            if (gastos.length > 0) {
                const porCategoria = gastos.reduce((acc, gasto) => {
                    acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.valor;
                    return acc;
                }, {});
                atualizarGrafico(porCategoria);
            } else {
                atualizarGrafico({});
            }
        });

        // Inicialização
        window.onload = function() {
            atualizarMesAtual();
            atualizarGrafico({});
        };
    </script>
</body>
</html>
