<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Controle de Gastos Mensal</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* (Manter os estilos anteriores) */
    </style>
</head>
<body>
    <!-- (Manter a estrutura HTML anterior) -->

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB_8NDa0J4LqFiyAlqgkOuJbwVxI9X2X2E",
            authDomain: "controle-gastos-5d942.firebaseapp.com",
            databaseURL: "https://controle-gastos-5d942-default-rtdb.firebaseio.com",
            projectId: "controle-gastos-5d942",
            storageBucket: "controle-gastos-5d942.appspot.com",
            messagingSenderId: "108583061894",
            appId: "1:108583061894:web:4c8f8d1e4e8d5e8a4d3e9a"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let grafico;
        let mesAtual = new Date().toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
        let gastosLocais = [];
        let editandoGasto = null;
        let listenerGastos = null;

        // Atualiza o cabe√ßalho com o m√™s atual
        function atualizarMesAtual() {
            document.getElementById('currentMonth').textContent = mesAtual.charAt(0).toUpperCase() + mesAtual.slice(1);
        }

        // Adiciona um novo gasto ou atualiza um existente
        function adicionarGasto() {
            const valorInput = document.getElementById('valor');
            const categoriaSelect = document.getElementById('categoria');
            
            const valor = parseFloat(valorInput.value);
            const categoria = categoriaSelect.value;
            
            if (isNaN(valor) || valor <= 0) {
                alert('Digite um valor v√°lido maior que zero!');
                return;
            }

            // Bot√£o de loading
            const addIcon = document.getElementById('addIcon');
            addIcon.innerHTML = '<div class="loading"></div>';
            
            if (editandoGasto) {
                // Atualiza um gasto existente
                const dataAtual = new Date().toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const gastoAtualizado = {
                    valor: valor,
                    categoria: categoria,
                    data: dataAtual, // Atualiza a data para a data da edi√ß√£o
                    mes: mesAtual
                };

                // Atualiza localmente
                const index = gastosLocais.findIndex(g => g.key === editandoGasto.key);
                if (index !== -1) {
                    gastosLocais[index] = {...gastosLocais[index], ...gastoAtualizado};
                }

                // Atualiza no Firebase (se n√£o for um item tempor√°rio)
                if (!editandoGasto.key.startsWith('temp-')) {
                    database.ref('gastos/' + editandoGasto.key).update(gastoAtualizado)
                        .catch(error => {
                            console.error("Erro ao atualizar no Firebase:", error);
                            alert('Erro ao atualizar o gasto. Verifique sua conex√£o.');
                        });
                }

                editandoGasto = null;
                document.querySelector('button.btn-primary').innerHTML = '<span id="addIcon">+</span> Adicionar';
            } else {
                // Cria objeto do novo gasto
                const data = new Date().toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const novoGasto = {
                    valor: valor,
                    categoria: categoria,
                    data: data,
                    mes: mesAtual,
                    key: 'temp-' + Date.now() // Chave tempor√°ria
                };

                // Adiciona localmente
                gastosLocais.push(novoGasto);

                // Envia para o Firebase
                database.ref('gastos').push({
                    valor: valor,
                    categoria: categoria,
                    data: data,
                    mes: mesAtual
                }).then((snapshot) => {
                    // Atualiza com a chave real quando retornar do Firebase
                    const index = gastosLocais.findIndex(g => g.key === novoGasto.key);
                    if (index !== -1) {
                        gastosLocais[index].key = snapshot.key;
                        atualizarInterface();
                    }
                }).catch(error => {
                    console.error("Erro ao salvar no Firebase:", error);
                    alert('Erro ao salvar o gasto. Verifique sua conex√£o.');
                });
            }
            
            // Atualiza a interface
            atualizarInterface();
            
            // Limpa o formul√°rio
            valorInput.value = '';
            categoriaSelect.selectedIndex = 0;
            valorInput.focus();
            
            // Restaura o √≠cone do bot√£o
            addIcon.textContent = '+';
        }

        // Remove um gasto
        function removerGasto(key) {
            if (confirm('Tem certeza que deseja remover este gasto?')) {
                // Remove localmente
                gastosLocais = gastosLocais.filter(gasto => gasto.key !== key);
                atualizarInterface();
                
                // Remove do Firebase (se n√£o for um item tempor√°rio)
                if (!key.startsWith('temp-')) {
                    database.ref('gastos/' + key).remove();
                }
            }
        }

        // Edita um gasto
        function editarGasto(key) {
            const gasto = gastosLocais.find(g => g.key === key);
            if (gasto) {
                editandoGasto = gasto;
                document.getElementById('valor').value = gasto.valor;
                document.getElementById('categoria').value = gasto.categoria;
                
                const btnAdicionar = document.querySelector('button.btn-primary');
                btnAdicionar.innerHTML = '<span id="addIcon">‚úì</span> Atualizar';
                
                document.getElementById('valor').focus();
            }
        }

        // Exporta para Excel e reseta o m√™s
        function exportarEResetar() {
            if (gastosLocais.filter(g => g.mes === mesAtual).length === 0) {
                alert('Nenhum gasto para exportar este m√™s!');
                return;
            }

            if (confirm(`Deseja exportar os gastos de ${mesAtual} e iniciar um novo m√™s?`)) {
                const exportIcon = document.getElementById('exportIcon');
                exportIcon.innerHTML = '<div class="loading"></div>';
                
                exportToExcel().then(() => {
                    resetarMes();
                    exportIcon.textContent = 'üìä';
                });
            }
        }

        // (Manter as fun√ß√µes exportToExcel, resetarMes, atualizarGrafico como antes)

        // Atualiza toda a interface
        function atualizarInterface() {
            const lista = document.getElementById('listaGastos');
            lista.innerHTML = '';
            
            const gastosDoMes = gastosLocais.filter(gasto => gasto.mes === mesAtual);
            let total = 0;
            
            // Ordena por data (mais recente primeiro)
            gastosDoMes.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            // Preenche a tabela
            gastosDoMes.forEach(gasto => {
                total += gasto.valor;
                
                const row = document.createElement('tr');
                row.dataset.key = gasto.key;
                row.innerHTML = `
                    <td>${gasto.data}</td>
                    <td>${gasto.categoria}</td>
                    <td>R$ ${gasto.valor.toFixed(2)}</td>
                    <td class="actions">
                        <button onclick="editarGasto('${gasto.key}')" class="btn-warning btn-sm">‚úèÔ∏è</button>
                        <button onclick="removerGasto('${gasto.key}')" class="btn-danger btn-sm">√ó</button>
                    </td>
                `;
                lista.appendChild(row);
            });

            // Atualiza o total
            document.getElementById('totalMes').textContent = `R$ ${total.toFixed(2)}`;
            
            // Atualiza o gr√°fico
            const porCategoria = gastosDoMes.reduce((acc, gasto) => {
                acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.valor;
                return acc;
            }, {});
            atualizarGrafico(porCategoria);
        }

        // Carrega os gastos do Firebase
        function carregarGastos() {
            // Remove listener anterior se existir
            if (listenerGastos) {
                listenerGastos();
            }
            
            // Carrega todos os gastos (n√£o apenas do m√™s atual)
            listenerGastos = database.ref('gastos').on('value', (snapshot) => {
                gastosLocais = [];
                
                snapshot.forEach((childSnapshot) => {
                    const gasto = childSnapshot.val();
                    gasto.key = childSnapshot.key;
                    gastosLocais.push(gasto);
                });
                
                atualizarInterface();
            });
        }

        // Inicializa√ß√£o
        window.onload = function() {
            atualizarMesAtual();
            carregarGastos();
        };

        // Limpa o listener quando a p√°gina √© fechada
        window.onbeforeunload = function() {
            if (listenerGastos) {
                listenerGastos();
            }
        };
    </script>
</body>
</html>
